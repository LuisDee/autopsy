---
name: maintain-docs
description: "Detects git changes and incrementally updates AGENTS.md files to keep documentation in sync with the codebase."
---

# Deep Review: Maintain Docs

You are the documentation maintenance command for deep-review. When the user runs `/deep-review:maintain-docs`, you detect what changed in the codebase and update the relevant AGENTS.md files.

**Key principle:** Only update what actually changed. Don't rewrite everything. Be specific. Append, don't replace.

---

## Step 1: Detect Changes

Identify what files changed recently using both commit history and time-based detection (whichever captures more):

```bash
# Changed files in last 10 commits
git diff --name-only HEAD~10 2>/dev/null | sort -u > /tmp/deep-review-changes.txt

# Changed files in last 7 days
git log --since="7 days ago" --name-only --pretty=format: 2>/dev/null | sort -u | grep -v '^$' >> /tmp/deep-review-changes.txt

# Deduplicate
sort -u /tmp/deep-review-changes.txt > /tmp/deep-review-changes-dedup.txt
mv /tmp/deep-review-changes-dedup.txt /tmp/deep-review-changes.txt

# Show what we found
echo "Changed files:"
cat /tmp/deep-review-changes.txt
```

If no changes detected (empty list), print "No changes detected in last 10 commits or 7 days." and exit.

---

## Step 2: Identify Affected Directories

Extract unique directories from the changed file list:

```bash
cat /tmp/deep-review-changes.txt | xargs -I{} dirname {} | sort -u
```

For each affected directory, determine if it has an existing AGENTS.md.

---

## Step 3: Update Existing AGENTS.md Files

For each affected directory that already has an AGENTS.md:

1. **Read the existing AGENTS.md**
2. **Read the changed files** in that directory
3. **Update the relevant sections:**
   - **Key Files:** Add new files, update descriptions for modified files, remove deleted files
   - **Data Flow:** Update if the processing pipeline changed
   - **Dependencies:** Add new imports/libraries, remove unused ones
   - **Configuration:** Add new env vars, config keys
   - **Gotchas:** Add any new non-obvious behavior discovered in changes
   - **Boundaries:** Update if responsibilities changed
4. **Add a dated entry to "Recent Changes":**
   ```markdown
   ## Recent Changes
   - {YYYY-MM-DD}: {one-line description of what changed and why}
   ```

**Rules:**
- Be specific: "Added retry logic to BigQuery client" not "Updated module"
- Don't remove information unless it's provably wrong
- Mark uncertainties with "TODO: verify"
- Keep Recent Changes entries to one line per change
- Respect the idempotency marker (`<!-- generated by deep-review -->`)

---

## Step 4: Create AGENTS.md for New Directories

For new directories (directories with changed files but no AGENTS.md):

Check if the directory has 3+ code files:

```bash
find "{dir}" -maxdepth 1 -type f \( -name '*.py' -o -name '*.js' -o -name '*.ts' -o -name '*.tsx' -o -name '*.jsx' -o -name '*.go' -o -name '*.rs' -o -name '*.java' -o -name '*.rb' -o -name '*.php' -o -name '*.c' -o -name '*.cpp' -o -name '*.cs' \) | wc -l
```

If 3+ code files, create an AGENTS.md using the standard template (same as discovery agent):

```markdown
<!-- generated by deep-review -->
# {Module Name}

## Purpose
{2-3 sentences}

## Key Files
| File | Purpose | Key Exports |
|------|---------|-------------|
| {file} | {what} | {exports} |

## Data Flow
{input → processing → output}

## Dependencies
- Internal: {modules}
- External: {libraries}

## Patterns & Conventions
- {patterns used}

## Configuration
- {env vars, config}

## Gotchas
- {non-obvious behavior}

## Testing
- Tests: {path}
- Run: {command}
- Gaps: {untested areas}

## Boundaries
- **Always:** {rules}
- **Ask first:** {caution areas}
- **Never:** {prohibited actions}

## Recent Changes
- {date}: Initial documentation created by maintain-docs
```

Also create a companion `CLAUDE.md` containing only `@AGENTS.md`.

---

## Step 5: Update Root AGENTS.md

Read the root AGENTS.md and update:

- **Directory Map:** Add entries for new directories, update descriptions for changed ones
- **Tech Stack:** Update if new dependencies, frameworks, or tools were added
- **Conventions:** Add any new patterns established in recent changes
- **Key Commands:** Update if build/test/run commands changed

---

## Step 6: Run Validation

Find directories that should have AGENTS.md but don't:

```bash
for dir in $(find . -type d | grep -v -E '(node_modules|\.git|__pycache__|venv|\.venv|dist|build|\.cache|\.idea|\.vscode|\.deep-review)'); do
  code_files=$(find "$dir" -maxdepth 1 -type f \( -name '*.py' -o -name '*.js' -o -name '*.ts' -o -name '*.tsx' -o -name '*.jsx' -o -name '*.go' -o -name '*.rs' -o -name '*.java' \) 2>/dev/null | wc -l)
  has_agents=$(test -f "$dir/AGENTS.md" && echo "yes" || echo "no")
  if [ "$code_files" -ge 3 ] && [ "$has_agents" = "no" ]; then
    echo "MISSING: $dir ($code_files code files, no AGENTS.md)"
  fi
done
```

---

## Step 7: Print Summary

```
═══════════════════════════════════════════
  DOCUMENTATION MAINTENANCE COMPLETE
═══════════════════════════════════════════

  Changed files detected:   {N}
  Directories affected:     {N}
  AGENTS.md updated:        {N}
  AGENTS.md created:        {N}
  Directories still missing AGENTS.md: {N}

  Updated files:
    {list of AGENTS.md files that were modified}

  Created files:
    {list of new AGENTS.md + CLAUDE.md files}

  Missing (consider running /deep-review:full-review):
    {list of directories that should have AGENTS.md}
═══════════════════════════════════════════
```
