# System Architecture

> Generated by `/architect-decompose` on 2026-02-07
> Based on: conductor/product.md, conductor/tech-stack.md

---

## System Overview

Deep-review is a Claude Code plugin that orchestrates 7 specialized sub-agents to perform exhaustive code review and generate living documentation. It is not a traditional software application — it is a collection of Markdown files with YAML frontmatter that instruct Claude Code's runtime.

The architecture follows an **Orchestrator-Worker pattern with sequential pipeline**: Phase 1 (Discovery) produces a repo map and batch plan, Phase 2 (Review) fans out to 5 parallel agents per batch, and Phase 3 (Synthesis) merges all findings into a final report. All inter-agent coordination happens via the filesystem (`.deep-review/` directory), keeping the orchestrator's context window light.

The plugin runs entirely within the Claude Code runtime. There are no external services, databases, or APIs. The "stack" is Markdown + JSON files interpreted by Claude Code's plugin system.

---

## Component Map

```
User runs /deep-review:full-review
         │
         ▼
┌─────────────────────────────────────────────────┐
│  ORCHESTRATOR (commands/full-review.md)          │
│  - Creates .deep-review/ working directory       │
│  - Launches agents via Task tool                 │
│  - Tracks progress via state.json + progress.md  │
│  - Never reads source code directly              │
└────────┬───────────────┬───────────────┬────────┘
         │               │               │
    Phase 1         Phase 2         Phase 3
         │               │               │
         ▼               ▼               ▼
┌────────────┐  ┌──────────────────┐  ┌──────────────┐
│ DISCOVERY  │  │ REVIEW AGENTS    │  │ SYNTHESIZER  │
│ (foreground)│  │ (5x background   │  │ (foreground)  │
│            │  │  per batch)      │  │              │
│ Writes:    │  │ ┌──────────────┐ │  │ Reads:       │
│ discovery  │  │ │ bug-hunter   │ │  │ all batch-*/ │
│ .md        │  │ │ security-    │ │  │ findings     │
│ batch-plan │  │ │  auditor     │ │  │              │
│ .md        │  │ │ error-       │ │  │ Writes:      │
│ AGENTS.md  │  │ │  inspector   │ │  │ REVIEW_      │
│ files      │  │ │ performance- │ │  │ REPORT.md    │
└────────────┘  │ │  detector    │ │  │ Updates root │
                │ │ stack-       │ │  │ AGENTS.md    │
                │ │  reviewer    │ │  └──────────────┘
                │ └──────────────┘ │
                │ Each writes to   │
                │ batch-{N}/*.md   │
                └──────────────────┘

Coordination: .deep-review/ directory (disk-based IPC)
```

---

## Technology Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Coordination layer | Filesystem (`.deep-review/`) | Sub-agents can't share memory; TaskOutput returns bloated JSONL; disk is reliable and survives compaction |
| Result retrieval | File polling (not TaskOutput) | TaskOutput returns full transcripts (issue #16789); polling for output files is more reliable |
| Background vs foreground agents | Review agents: background; Discovery/Synthesizer: foreground | Review agents are independent and parallelizable; Discovery/Synthesizer need sequential orchestration |
| Documentation format | `AGENTS.md` primary + `CLAUDE.md` companion | Cross-LLM compatibility; Claude Code reads `@AGENTS.md` reference in CLAUDE.md |
| Progress tracking | Dual: `state.json` (machine) + `progress.md` (human) | Machine-readable for resume after compaction; human-readable for user visibility |
| Max parallelism | 5 agents per batch | Practical limit from research; avoids rate limit issues |

---

## Architecture Decision Records

### ADR-001: File-Based Coordination Over TaskOutput

- **Status:** Accepted
- **Date:** 2026-02-07
- **Context:** Sub-agents need to communicate results to the orchestrator. TaskOutput (the built-in mechanism) returns full JSONL transcripts that bloat the orchestrator's context. Background task notifications may not fire reliably.
- **Decision:** All agents write results to specific file paths in `.deep-review/`. The orchestrator polls for file existence and reads only summaries. State is tracked in `state.json`.
- **Consequences:** Orchestrator context stays light. Resume after compaction is possible by re-reading state files. Adds file I/O overhead but this is negligible for Markdown files.

### ADR-002: AGENTS.md as Primary Documentation Format

- **Status:** Accepted
- **Date:** 2026-02-07
- **Context:** The plugin generates documentation files in every significant directory. CLAUDE.md is Claude Code-specific. AGENTS.md is an open standard supported by Claude Code, Cursor, Copilot, Codex, Gemini CLI, and 60,000+ repos.
- **Decision:** Generate `AGENTS.md` as the primary documentation file. Generate a thin `CLAUDE.md` containing only `@AGENTS.md` for Claude Code compatibility.
- **Consequences:** Documentation is useful across all LLM coding tools. Requires generating two files per directory instead of one. Claude Code compatibility preserved via the `@` reference mechanism.

### ADR-003: No External Plugin Dependencies

- **Status:** Accepted
- **Date:** 2026-02-07
- **Context:** Companion plugins (ast-grep, GrepAI, claude-context-local) could provide enhanced search capabilities. However, MCP tools are not available in background sub-agents, and the review agents do their own exhaustive file reading.
- **Decision:** The plugin has zero external dependencies. Companion plugins are documented as optional optimizations in README but not required.
- **Consequences:** Plugin works out-of-the-box with just Claude Code. Sub-agents rely on built-in Read/Grep/Glob tools. The discovery agent's file mapping may be slightly less sophisticated but is fully functional.

### ADR-004: Compaction-Safe Design Over Compaction Rules

- **Status:** Accepted
- **Date:** 2026-02-07
- **Context:** Large repo reviews may trigger auto-compaction in the orchestrator's context. The orchestrator needs to resume seamlessly.
- **Decision:** Write all critical state to disk (`state.json`, `progress.md`, `batch-plan.md`) before every compaction risk point. After compaction, re-read state from disk. Compaction safety is built into the orchestrator command instructions, not project-level CLAUDE.md.
- **Consequences:** The plugin is self-contained — no project-level config changes needed. State recovery is deterministic. The orchestrator command file is larger but includes all resilience logic.

---

## Accepted Architecture Patterns

| Pattern | Tier | Rationale |
|---------|------|-----------|
| Orchestrator-Worker | Strongly Recommended | Core architecture — 1 orchestrator coordinates 7 specialized worker agents |
| File-Based IPC | Strongly Recommended | Disk as coordination layer between agents; avoids context bloat |
| Dual-Layer Progress Tracking | Strongly Recommended | `state.json` (machine) + `progress.md` (human) for compaction-safe resume |
| Self-Review Step | Strongly Recommended | Each agent verifies its own output completeness before finishing |
| Few-Shot Examples | Strongly Recommended | 2-3 concrete finding examples per agent prompt improves quality |
| Confidence Scoring | Recommended | High/Medium/Low per finding enables noise filtering at synthesis |
| Companion File Strategy | Recommended | AGENTS.md + thin CLAUDE.md for cross-LLM compatibility |

---

## Deferred Pattern Triggers

| Pattern | Trigger Condition | Discovery Classification |
|---------|-------------------|--------------------------|
| Agent Memory | Plugin used 3+ times on same repo; agents should learn codebase-specific patterns | CROSS_CUTTING_CHANGE |
| Companion Plugin Integration | User reports discovery phase taking >10 minutes on repos with 500+ files | NEW_TRACK |
